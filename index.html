<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEE Rolling Average Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Sunlit Pine Palette */
            --sunlit-pine: #4a5d2f;
            --golden-meadow: #7ba05b;
            --honey-gold: #d4af37;
            --warm-amber: #c7a875;
            --cream-sunshine: #f2e6c7;
            --summer-breeze: #fef9f0;
            --danger-red: #EF4444;

            /* Derived variables */
            --bg-main: var(--summer-breeze);
            --bg-card: white;
            --bg-card-subtle: var(--cream-sunshine);
            --bg-hover: rgba(74, 93, 47, 0.05);
            --text-primary: var(--sunlit-pine);
            --text-secondary: #5a723a;
            --text-muted: var(--warm-amber);
            --text-on-accent: white;
            --border-primary: var(--warm-amber);
            --border-subtle: rgba(74, 93, 47, 0.2);
            --accent-primary: var(--golden-meadow);
            --accent-secondary: var(--honey-gold);
            --accent-gradient: linear-gradient(135deg, var(--golden-meadow) 0%, #6a8d4a 100%);
            --glow-accent: 0 0 20px rgba(123, 160, 91, 0.5);
            --glow-secondary: 0 0 20px rgba(212, 175, 55, 0.4);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .hero-section {
            height: 70vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4rem;
            background-image: url('https://i.imgur.com/1ni1cSt.jpeg');
            background-size: cover;
            background-position: center;
        }

        .hero-section::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.5), transparent 40%);
            z-index: 0;
        }

        .hero-content {
            text-align: center;
            z-index: 1;
            max-width: 900px;
            padding: 0 2rem;
            animation: fadeInUp 1s ease-out;
        }

        .hero-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: clamp(3rem, 6vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
        }

        .hero-title span {
            color: #ffffff;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .hero-logo {
            height: 1.1em;
            width: 1.1em;
            padding: 0.1em;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            box-sizing: border-box;
            box-shadow: var(--shadow-card);
        }

        .hero-subtitle {
            font-size: 1.4rem;
            color: #ffffff;
            margin-bottom: 2.5rem;
            font-weight: 500;
            max-width: 700px;
            margin: 0 auto 2.5rem auto;
            line-height: 1.6;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .hero-stat {
            text-align: center;
            padding: 1rem 2rem;
            background: #ffffff;
            /* Changed to solid white */
            backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .hero-stat:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-elevated);
        }

        .hero-stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: block;
        }

        .hero-stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hero-image-source {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            background: rgba(10, 15, 30, 0.6);
            backdrop-filter: blur(5px);
            color: #fef9f0;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-size: 0.8rem;
            text-align: right;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
            z-index: 2;
            white-space: nowrap;
            /* Ensures single line */
        }

        .hero-image-source a {
            color: inherit;
            text-decoration: none;
        }

        .hero-image-source:hover {
            background: rgba(10, 15, 30, 0.8);
        }


        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--bg-card-subtle);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid var(--border-subtle);
            justify-content: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 2rem;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            background: var(--accent-gradient);
            color: var(--text-on-accent);
            transform: translateY(-2px);
            box-shadow: var(--glow-accent);
        }

        .tab-button:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .explanation-panel {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            border: 1px solid var(--accent-secondary);
            box-shadow: var(--glow-secondary);
        }

        .explanation-panel h3 {
            color: var(--accent-secondary);
            margin-bottom: 1.5rem;
            font-size: 1.6rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
        }

        .explanation-panel p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .explanation-panel code {
            background: var(--bg-card-subtle);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent-primary);
            font-family: 'Courier New', monospace;
        }

        .explanation-panel .highlight {
            background: rgba(212, 175, 55, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-secondary);
            margin: 1rem 0;
        }

        .controls {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
        }

        .controls:hover {
            box-shadow: var(--shadow-elevated);
            border-color: var(--border-primary);
        }

        .controls h3 {
            color: var(--text-primary);
            margin-bottom: 2rem;
            font-size: 1.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .control-group {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 1.1rem;
        }

        .control-group input {
            padding: 14px 18px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .control-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(123, 160, 91, 0.2);
            background: white;
        }

        .btn {
            padding: 14px 28px;
            background: var(--accent-gradient);
            color: var(--text-on-accent);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-accent);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            box-shadow: var(--glow-secondary);
            color: var(--text-primary);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2.5rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2.5rem;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-card);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-elevated);
            border-color: var(--border-primary);
        }

        .panel:hover::before {
            opacity: 1;
        }

        .panel h3 {
            color: var(--text-primary);
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .metric-value {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .peak-metric-value {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            background-color: var(--bg-card-subtle);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-main);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            white-space: normal;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .large-panel {
            grid-column: 1 / -1;
        }

        .large-system-panel {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 2rem;
            background: var(--bg-card-subtle);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-subtle);
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .legend-color-box {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .dataset-list {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-secondary) transparent;
        }

        .dataset-list::-webkit-scrollbar {
            width: 6px;
        }

        .dataset-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .dataset-list::-webkit-scrollbar-thumb {
            background: var(--accent-secondary);
            border-radius: 3px;
        }

        .dataset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .dataset-item:last-child {
            margin-bottom: 0;
        }

        .dataset-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
            border-color: var(--border-primary);
        }

        .dataset-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }

        .dataset-rank {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-muted);
            width: 2rem;
            text-align: center;
            flex-shrink: 0;
        }

        .dataset-details {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .dataset-name {
            font-size: 1rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .dataset-users {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .dataset-growth {
            font-weight: 600;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .icon {
            font-size: 1.5rem;
            color: var(--accent-primary);
        }

        #dashboardPeriodFooter {
            text-align: center;
            color: var(--text-muted);
            font-size: 1rem;
            padding: 0 0 4rem 0;
            font-family: 'Space Grotesk', sans-serif;
        }

        /* System Details Tab Styles */
        .system-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .details-section {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-card);
        }

        .details-section h4 {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-family: 'Space Grotesk', sans-serif;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .details-section ul {
            list-style-position: inside;
            padding-left: 1rem;
        }

        .details-section li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .math-equation {
            background: var(--bg-card-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .math-equation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }

        .equation-title {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        .equation-explanation {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-top: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        .info-box {
            background: rgba(123, 160, 91, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
        }

        .info-box .info-title {
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1.2rem;
            }

            .hero-stats {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .container {
                padding: 0 1rem;
            }

            .panel,
            .controls,
            .explanation-panel {
                padding: 2rem;
            }
        }
    </style>
</head>

<body>
    <section class="hero-section">
        <div class="hero-content">
            <a href="https://developers.google.com/earth-engine/datasets/community/sat-io"
                style="text-decoration: none; color: inherit; display: block;">
                <h1 class="hero-title">
                    <img src="https://i.imgur.com/pCG0FFu.png" alt="Earth Engine Logo" class="hero-logo">
                    <span>GEE&nbsp;Rolling&nbsp;Average<br>Analytics&nbsp;Dashboard</span>
                </h1>
                <p class="hero-subtitle">Comprehensive analytics for 30-day rolling average usage trends from the NEON
                    Publisher Catalog.</p>
            </a>
            <div class="hero-stats">
                <div class="hero-stat">
                    <span class="hero-stat-number" id="heroCurrentAvg">-</span>
                    <span class="hero-stat-label">Current 30-Day Avg</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number" id="heroTotalDatasets">-</span>
                    <span class="hero-stat-label">Active Datasets</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number" id="heroGrowthRate">-</span>
                    <span class="hero-stat-label">Trend Rate</span>
                </div>
            </div>
        </div>
        <div class="hero-image-source">
            <a href="https://www.neonscience.org/field-sites/leno" target="_blank" rel="noopener noreferrer">
                Image Source: Lenoir Landing NEON / LENO
            </a>
        </div>
    </section>

    <div class="container">
        <div class="explanation-panel">
            <h3>üîç Understanding Rolling Average Data</h3>
            <p>Google Metrics CSV data contains <strong>30-day rolling averages</strong>, not daily counts. This means:
            </p>
            <div class="highlight">
                <p><strong>April 15 CSV:</strong> Shows average daily users from March 16 to April 15 (30 days)</p>
                <p><strong>April 16 CSV:</strong> Shows average daily users from March 17 to April 16 (30 days)</p>
                <p><strong>Each data point represents:</strong> <code>Total users in 30-day window √∑ 30</code></p>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('analytics')">Analytics Dashboard</button>
            <button class="tab-button" onclick="switchTab('system')">System Details & Metrics</button>
        </div>

        <div id="loadingMessage"
            style="text-align: center; color: var(--text-primary); font-size: 1.5rem; padding: 5rem 0;">
            Loading Analytics Data...
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content active">
                <div class="controls">
                    <h3><span class="icon">üöÄ</span> Analysis Controls</h3>
                    <div class="control-group">
                        <label>Time Range:</label>
                        <input type="date" id="startDate">
                        <span style="color: var(--text-secondary);">to</span>
                        <input type="date" id="endDate">
                        <div class="btn-group">
                            <button class="btn" onclick="setDateRange(30)">30 Days</button>
                            <button class="btn" onclick="setDateRange(60)">60 Days</button>
                            <button class="btn" onclick="setDateRange(90)">90 Days</button>
                            <button class="btn" onclick="setDateRange(1)">Latest</button>
                            <button class="btn btn-secondary" onclick="downloadJSON()">Download JSON</button>
                        </div>
                    </div>
                </div>

                <div class="dashboard">
                    <div class="panel">
                        <h3><span class="icon">üìà</span> Summary Statistics</h3>
                        <div class="panel-content" id="summaryStats"></div>
                    </div>
                    <div class="panel">
                        <h3><span class="icon">üèÜ</span> Peak Performance</h3>
                        <div class="panel-content" id="peakStats"></div>
                    </div>
                    <div class="panel">
                        <h3><span class="icon">üõ∞Ô∏è</span> Top Datasets</h3>
                        <div class="dataset-list" id="datasetList"></div>
                    </div>
                    <div class="panel large-panel">
                        <h3><span class="icon">üìÖ</span> Daily Rolling Average Trends (30-Day Window)</h3>
                        <div class="chart-container"><canvas id="dailyChart"></canvas></div>
                    </div>
                    <div class="panel">
                        <h3><span class="icon">üóìÔ∏è</span> Weekly Trends</h3>
                        <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
                    </div>
                    <div class="panel">
                        <h3><span class="icon">üåä</span> Monthly Trends</h3>
                        <div class="chart-container"><canvas id="monthlyLineChart"></canvas></div>
                    </div>
                    <!-- Re-added Monthly Distribution Chart -->
                    <div class="panel">
                        <h3><span class="icon">üåç</span> Monthly Distribution</h3>
                        <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                        <div id="monthlyLegend" class="chart-legend"></div>
                    </div>
                </div>
            </div>

            <!-- System Details & Metrics Tab -->
            <div id="system-tab" class="tab-content">
                <div class="system-details-grid">
                    <div class="details-section">
                        <h4>How Metrics Are Calculated</h4>
                        <div class="math-equation">
                            <div class="equation-title">Total Datasets Used</div>
                            <div class="equation-explanation">
                                This is the total count of unique datasets that have usage data within the selected
                                time period.
                            </div>
                        </div>
                        <div class="math-equation">
                            <div class="equation-title">Rolling Average Sum</div>
                            <div class="equation-explanation">
                                We sum the rolling average values for each day in the selected period. This is not
                                the total number of unique users.
                            </div>
                        </div>
                        <div class="math-equation">
                            <div class="equation-title">Mean Rolling Average</div>
                            <div class="equation-explanation">
                                Calculated by taking the "Rolling Average Sum" and dividing it by the number of days
                                in the selected period.
                            </div>
                        </div>
                        <div class="math-equation">
                            <div class="equation-title">Period Trend Rate</div>
                            <div class="equation-explanation">
                                This shows the percentage change from the first day's rolling average to the last
                                day's rolling average in the selected period.
                            </div>
                        </div>
                    </div>
                    <div class="details-section">
                        <h4>System Diagram</h4>
                        <div class="info-box">
                            <div class="info-title">Google Earth Engine</div>
                            <p>Cloud-Based Geospatial Platform</p>
                        </div>
                        <div class="info-box">
                            <div class="info-title">GitHub Actions + Python Analytics</div>
                            <p>Scheduled daily workflow that fetches GEE logs, processes analytics, and generates
                                structured data (<code>catalog_stats.json</code>).</p>
                        </div>
                        <div class="info-box">
                            <div class="info-title">Interactive Dashboard</div>
                            <p>This responsive dashboard, which fetches the live data and uses Chart.js to render
                                all statistics.</p>
                        </div>
                    </div>
                    <div class="details-section large-system-panel">
                        <h4>Core Components & Key Metrics</h4>
                        <ul>
                            <li><strong>Data Source:</strong> Raw data originates from Google Earth Engine's usage
                                logs, recording unique users for community datasets over a revolving 30-day window.
                            </li>
                            <li><strong>Automated Data Pipeline:</strong> A Python script (ee-usage-stats), run by a
                                GitHub Action daily, fetches usage numbers and compiles the
                                <code>catalog_stats.json</code> file.
                            </li>
                            <li><strong>Interactive Dashboard:</strong> This client-side application fetches the
                                <code>catalog_stats.json</code> file and uses Chart.js to render interactive charts
                                and statistics.
                            </li>
                            <li><strong>30-Day Revolving Window:</strong> User counts reflect unique individuals
                                accessing an asset in the preceding 30 days, a standard GEE metric.</li>
                            <li><strong>Peak Performance:</strong> The dashboard identifies the day with the highest
                                number of total users for the selected time period.</li>
                            <li><strong>Top Datasets:</strong> Datasets are ranked by their total rolling average
                                users over the selected period.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="dashboardPeriodFooter"></div>
        </div>
    </div>

    <script>
        let rawData = {};
        let dailyChart, weeklyChart, monthlyLineChart, monthlyChart; // Added monthlyChart
        let currentPeriodLabel = '';

        const datasetMap = {
            'projects/neon-prod-earthengine/assets/CHM/001': 'NEON Canopy Height Model',
            'projects/neon-prod-earthengine/assets/DEM/001': 'NEON Digital Elevation Model (DEM)',
            'projects/neon-prod-earthengine/assets/RGB/001': 'NEON RGB Camera Imagery',
            'projects/neon-prod-earthengine/assets/HSI_REFL/002': 'NEON Surface Bidirectional Reflectance',
            'projects/neon-prod-earthengine/assets/HSI_REFL/001': 'NEON Surface Directional Reflectance'
        };

        const DATA_URL = 'catalog_stats.json';

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                rawData = await response.json();

                // Transform the data structure if needed
                if (Array.isArray(rawData.moving_window_snapshots)) {
                    const transformedData = {};
                    rawData.moving_window_snapshots.forEach(snapshot => {
                        const dateKey = snapshot.date;
                        transformedData[dateKey] = {};
                        // Extract dataset IDs and user counts from the datasets object
                        Object.entries(snapshot.datasets || {}).forEach(([datasetId, datasetInfo]) => {
                            transformedData[dateKey][datasetId] = datasetInfo.users;
                        });
                    });
                    rawData.moving_window_snapshots = transformedData;
                }

                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                init();
            } catch (error) {
                console.error("Failed to fetch or process data:", error);
                document.getElementById('loadingMessage').innerHTML = `<p style="color: var(--danger-red);">Error: Could not load analytics data.</p><p style="font-size: 1rem; color: var(--text-muted)">${error.message}</p>`;
            }
        });

        function downloadJSON() {
            if (!rawData || Object.keys(rawData).length === 0) {
                alert("No data available to download.");
                return;
            }
            const dataStr = JSON.stringify(rawData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gee-asset-analytics-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function init() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded!');
                return;
            }
            initCharts();

            const dailyData = rawData.moving_window_snapshots || rawData.daily_data || {};
            const allDates = Object.keys(dailyData).sort();
            if (allDates.length === 0) return;

            const latestDate = allDates[allDates.length - 1];
            const defaultStartDate = new Date(latestDate);
            defaultStartDate.setDate(defaultStartDate.getDate() - 89);

            document.getElementById('endDate').value = latestDate;
            document.getElementById('startDate').value = defaultStartDate.toISOString().split('T')[0];
            currentPeriodLabel = 'for the last 90-day period';

            const updateFunc = () => {
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);
                const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
                currentPeriodLabel = `for the selected ${diffDays}-day period`;
                updateDashboard();
            };
            document.getElementById('startDate').addEventListener('change', updateFunc);
            document.getElementById('endDate').addEventListener('change', updateFunc);
            updateDashboard();
        }

        function setDateRange(days) {
            currentPeriodLabel = days === 1 ? 'for the latest day' : `for the selected ${days}-day period`;
            const dailyData = rawData.moving_window_snapshots || rawData.daily_data || {};
            const allDates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const latestDateStr = allDates[allDates.length - 1];
            const endDate = new Date(latestDateStr + 'T00:00:00');
            let startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - (days - 1));
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            updateDashboard();
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00');
            const endDate = new Date(document.getElementById('endDate').value + 'T23:59:59');
            const { filteredData, datasets } = processRawData(startDate, endDate);
            if (Object.keys(filteredData).length === 0) return;
            const stats = computeStatistics(filteredData, datasets);
            updateHeroStats(stats);
            updateSummaryStats(stats);
            updatePeakStats(stats, filteredData);
            updateDatasetList(startDate, endDate);
            updateCharts(stats);
            updateFooter();
        }

        function processRawData(startDate, endDate) {
            const filteredData = {};
            const datasets = new Set();
            const dailyData = rawData.moving_window_snapshots || rawData.daily_data || {};
            for (const [dateStr, dayData] of Object.entries(dailyData)) {
                const date = new Date(dateStr + 'T00:00:00');
                if (date >= startDate && date <= endDate) {
                    filteredData[dateStr] = dayData;
                    Object.keys(dayData).forEach(dataset => datasets.add(dataset));
                }
            }
            return { filteredData, datasets: Array.from(datasets) };
        }

        function computeStatistics(filteredData, datasets) {
            const dailyTotals = {};
            for (const [dateStr, dayData] of Object.entries(filteredData)) {
                dailyTotals[dateStr] = { total_users: Object.values(dayData).reduce((sum, users) => sum + users, 0) };
            }
            const totalUsers = Object.values(dailyTotals).reduce((sum, day) => sum + day.total_users, 0);
            const sortedDates = Object.keys(dailyTotals).sort();
            let growthRate = 0;
            if (sortedDates.length > 1) {
                const firstDay = dailyTotals[sortedDates[0]].total_users;
                const lastDay = dailyTotals[sortedDates[sortedDates.length - 1]].total_users;
                if (firstDay > 0) growthRate = ((lastDay - firstDay) / firstDay) * 100;
            }
            let peakDay = null, maxUsers = -1;
            for (const [dateStr, dayData] of Object.entries(dailyTotals)) {
                if (dayData.total_users > maxUsers) {
                    maxUsers = dayData.total_users;
                    peakDay = { date: dateStr, total_users: dayData.total_users };
                }
            }
            return {
                summary: { total_datasets: datasets.length, total_users: totalUsers, growth_rate: growthRate },
                peaks: { peak_day: peakDay },
                daily_trends: dailyTotals,
            };
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function updateHeroStats(stats) {
            const sortedDates = Object.keys(stats.daily_trends).sort();
            const currentAvg = sortedDates.length > 0 ? stats.daily_trends[sortedDates[sortedDates.length - 1]].total_users : 0;
            document.getElementById('heroCurrentAvg').textContent = formatNumber(currentAvg);
            document.getElementById('heroTotalDatasets').textContent = stats.summary.total_datasets.toLocaleString();
            const growthRateEl = document.getElementById('heroGrowthRate');
            const growthRate = stats.summary.growth_rate;
            growthRateEl.textContent = `${growthRate.toFixed(1)}%`;
            growthRateEl.style.color = growthRate >= 0 ? '#22c55e' : 'var(--danger-red)';
        }

        function updateSummaryStats(stats) {
            const avgUsersPerDay = stats.summary.total_users / Object.keys(stats.daily_trends).length;
            const growthRate = stats.summary.growth_rate;
            document.getElementById('summaryStats').innerHTML = `
                <div class="metric tooltip" data-tooltip="Total count of unique datasets with usage in the selected period."><span class="metric-label">Total Datasets Used</span><span class="metric-value">${stats.summary.total_datasets.toLocaleString()}</span></div>
                <div class="metric tooltip" data-tooltip="Sum of all rolling averages per day. Not unique users."><span class="metric-label">Rolling Avg Sum</span><span class="metric-value">${stats.summary.total_users.toLocaleString()}</span></div>
                <div class="metric"><span class="metric-label">Mean Rolling Average</span><span class="metric-value">${formatNumber(Math.round(avgUsersPerDay))}</span></div>
                <div class="metric"><span class="metric-label">Period Trend Rate</span><span class="metric-value" style="color: ${growthRate >= 0 ? '#22c55e' : 'var(--danger-red)'}">${growthRate.toFixed(1)}%</span></div>
            `;
        }

        function updatePeakStats(stats, filteredData) {
            const datasetTotals = {};
            for (const dayData of Object.values(filteredData)) {
                for (const [dataset, users] of Object.entries(dayData)) {
                    datasetTotals[dataset] = (datasetTotals[dataset] || 0) + users;
                }
            }
            const sorted = Object.entries(datasetTotals).sort((a, b) => b[1] - a[1]);
            const topDataset = sorted.length > 0 ? { name: sorted[0][0], total_users: sorted[0][1] } : { name: 'N/A', total_users: 0 };
            const topDatasetName = topDataset.name ? (datasetMap[topDataset.name] || topDataset.name.split('/').pop()) : 'N/A';
            document.getElementById('peakStats').innerHTML = `
                <div class="metric"><span class="metric-label">Peak Day</span><span class="peak-metric-value">${stats.peaks.peak_day ? stats.peaks.peak_day.date : '-'}</span></div>
                <div class="metric"><span class="metric-label">Peak Rolling Avg</span><span class="peak-metric-value">${stats.peaks.peak_day ? formatNumber(stats.peaks.peak_day.total_users) : '-'}</span></div>
                <div class="metric"><span class="metric-label">Top Dataset</span><span class="peak-metric-value" title="${topDataset.name}">${topDatasetName}</span></div>
            `;
        }

        function updateDatasetList(currentStartDate, currentEndDate) {
            const diffDays = Math.ceil((currentEndDate - currentStartDate) / (1000 * 3600 * 24));
            const prevEndDate = new Date(currentStartDate - 1);
            const prevStartDate = new Date(prevEndDate.getTime() - (diffDays * 1000 * 3600 * 24));
            const currentPeriodTotals = {}, previousPeriodTotals = {};
            const dailyData = rawData.moving_window_snapshots || rawData.daily_data || {};
            for (const [dateStr, dayData] of Object.entries(dailyData)) {
                const date = new Date(dateStr + 'T00:00:00');
                if (date >= currentStartDate && date <= currentEndDate) {
                    for (const [dataset, users] of Object.entries(dayData)) currentPeriodTotals[dataset] = (currentPeriodTotals[dataset] || 0) + users;
                } else if (date >= prevStartDate && date <= prevEndDate) {
                    for (const [dataset, users] of Object.entries(dayData)) previousPeriodTotals[dataset] = (previousPeriodTotals[dataset] || 0) + users;
                }
            }
            const sortedDatasets = Object.entries(currentPeriodTotals).sort((a, b) => b[1] - a[1]);
            const datasetList = document.getElementById('datasetList');
            datasetList.innerHTML = '';
            sortedDatasets.slice(0, 5).forEach(([name, total_users], index) => {
                const prevUsers = previousPeriodTotals[name] || 0;
                let growth = prevUsers > 0 ? ((total_users - prevUsers) / prevUsers) * 100 : (total_users > 0 ? 100 : 0);
                let growthText = `${growth > 0 ? '+' : ''}${growth.toFixed(0)}%`;
                let growthColor = growth > 0 ? '#22c55e' : (growth < 0 ? 'var(--danger-red)' : 'var(--text-muted)');
                const displayName = datasetMap[name] || name.split('/').pop();
                datasetList.innerHTML += `
                    <div class="dataset-item">
                        <div class="dataset-info">
                            <span class="dataset-rank">#${index + 1}</span>
                            <div class="dataset-details">
                                <span class="dataset-name" title="${name}">${displayName}</span>
                                <span class="dataset-users">${formatNumber(total_users)} avg users</span>
                            </div>
                        </div>
                        <span class="dataset-growth" style="background-color: ${growthColor}20; color: ${growthColor};">${growthText}</span>
                    </div>`;
            });
        }

        function updateCharts(stats) {
            const sortedDates = Object.keys(stats.daily_trends).sort();
            const datasets = new Set();
            const dailyData = rawData.moving_window_snapshots || rawData.daily_data || {};
            for (const dateStr of sortedDates) {
                Object.keys(dailyData[dateStr]).forEach(dataset => datasets.add(dataset));
            }
            const totalData = sortedDates.map(date => ({ x: date, y: stats.daily_trends[date].total_users }));

            const chartDatasets = [{
                label: 'Total Users (30-Day Avg)',
                data: totalData,
                borderColor: initCharts.chartColors.pine,
                backgroundColor: 'rgba(45, 58, 31, 0.2)',
                fill: true, tension: 0.4, borderWidth: 3
            }];

            const datasetColors = [initCharts.chartColors.rust, initCharts.chartColors.slate];
            Array.from(datasets).slice(0, 2).forEach((dataset, index) => {
                const datasetData = sortedDates.map(date => ({ x: date, y: (dailyData[date] || {})[dataset] || 0 }));
                chartDatasets.push({
                    label: datasetMap[dataset] || dataset.split('/').pop(),
                    data: datasetData,
                    borderColor: datasetColors[index],
                    backgroundColor: `${datasetColors[index]}33`,
                    fill: false, tension: 0.4, borderWidth: 2
                });
            });
            dailyChart.data.datasets = chartDatasets;
            dailyChart.update();

            const weeklyData = {};
            for (const [dateStr, dayData] of Object.entries(stats.daily_trends)) {
                const date = new Date(dateStr);
                const weekLabel = `${date.getFullYear()}-W${Math.ceil((((new Date(date.getFullYear(), date.getMonth(), date.getDate()) - new Date(date.getFullYear(), 0, 1)) / 86400000) + 1) / 7)}`;
                weeklyData[weekLabel] = (weeklyData[weekLabel] || 0) + dayData.total_users;
            }
            const sortedWeekly = Object.entries(weeklyData).sort((a, b) => a[0].localeCompare(b[0]));
            weeklyChart.data.labels = sortedWeekly.map(d => d[0]);
            weeklyChart.data.datasets[0].data = sortedWeekly.map(d => d[1]);
            weeklyChart.update();

            const monthlyData = {};
            for (const [dateStr, dayData] of Object.entries(stats.daily_trends)) {
                const date = new Date(dateStr);
                const monthLabel = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyData[monthLabel] = (monthlyData[monthLabel] || { total: 0, count: 0 });
                monthlyData[monthLabel].total += dayData.total_users;
                monthlyData[monthLabel].count++;
            }
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const sortedMonthly = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const monthlyLabels = sortedMonthly.map(([label]) => `${monthNames[parseInt(label.split('-')[1]) - 1]} ${label.split('-')[0]}`);

            monthlyLineChart.data.labels = monthlyLabels;
            monthlyLineChart.data.datasets[0].data = sortedMonthly.map(d => d[1].total);
            monthlyLineChart.data.datasets[1].data = sortedMonthly.map(d => d[1].total / d[1].count);
            monthlyLineChart.update();

            // Update monthly distribution chart
            const monthColors = ['#4a5d2f', '#7ba05b', '#d4af37', '#c7a875', '#8a795d', '#a99985'];
            const backgroundColors = sortedMonthly.map((_, index) => monthColors[index % monthColors.length]);

            monthlyChart.data.labels = monthlyLabels;
            monthlyChart.data.datasets[0].data = sortedMonthly.map(d => d[1].total);
            monthlyChart.data.datasets[0].backgroundColor = backgroundColors;
            monthlyChart.update();
            generateCustomLegend(monthlyChart, 'monthlyLegend');
        }

        function generateCustomLegend(chart, containerId) {
            const legendContainer = document.getElementById(containerId);
            legendContainer.innerHTML = '';
            const labels = chart.data.labels;
            const colors = chart.data.datasets[0].backgroundColor;
            labels.forEach((label, index) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="legend-color-box" style="background-color: ${colors[index]};"></span><span>${label}</span>`;
                legendContainer.appendChild(item);
            });
        }

        function updateFooter() {
            document.getElementById('dashboardPeriodFooter').textContent = `Dashboard showing 30-day rolling average analytics ${currentPeriodLabel}`;
        }

        function initCharts() {
            const chartColors = {
                grid: 'rgba(74, 93, 47, 0.1)',
                text: 'var(--text-secondary)',
                pine: '#2d3a1f',
                rust: '#c97b5f',
                slate: '#6a7a8c',
                meadow: 'var(--golden-meadow)'
            };
            initCharts.chartColors = chartColors;

            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, labels: { color: chartColors.text, font: { size: 12 }, usePointStyle: true } } },
                scales: {
                    x: { ticks: { color: chartColors.text, font: { size: 12 } }, grid: { color: chartColors.grid, drawOnChartArea: false } },
                    y: { ticks: { color: chartColors.text, font: { size: 12 } }, grid: { color: chartColors.grid } }
                }
            };
            dailyChart = new Chart('dailyChart', { type: 'line', data: { datasets: [] }, options: defaultOptions });
            weeklyChart = new Chart('weeklyChart', {
                type: 'bar',
                data: { datasets: [{ label: 'Weekly Rolling Avg Sum', backgroundColor: 'rgba(123, 160, 91, 0.6)', borderColor: chartColors.meadow, borderWidth: 2, borderRadius: 4 }] },
                options: defaultOptions
            });
            monthlyLineChart = new Chart('monthlyLineChart', {
                type: 'line',
                data: {
                    labels: [], datasets: [
                        { label: 'Total Rolling Avg', borderColor: chartColors.pine, tension: 0.4, yAxisID: 'y' },
                        { label: 'Average Rolling Avg', borderColor: chartColors.rust, tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    ...defaultOptions, scales: {
                        x: defaultOptions.scales.x,
                        y: { ...defaultOptions.scales.y, position: 'left', title: { display: true, text: 'Total Rolling Avg', color: chartColors.text } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: chartColors.text }, title: { display: true, text: 'Average Rolling Avg', color: chartColors.text } }
                    }
                }
            });
            // Init for monthly distribution chart
            monthlyChart = new Chart('monthlyChart', {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderColor: 'var(--bg-card-subtle)',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
    </script>
</body>

</html>
