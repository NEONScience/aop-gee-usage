<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON EML Data Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and scrollbar styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #a8b5c4;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8895a4;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hero-bg {
            background-image: url('https://i.imgur.com/SRmc5dh.jpeg');
            background-size: cover;
            background-position: center;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
    </style>
</head>

<body class="antialiased text-slate-800">
    <div class="min-h-screen bg-gradient-to-br from-sky-50 to-slate-200 p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Hero Section -->
            <div class="hero-bg h-64 rounded-2xl shadow-lg flex items-center justify-center mb-8 p-4">
                <div class="text-center bg-black bg-opacity-50 text-white p-6 rounded-xl">
                    <h1 class="text-4xl md:text-5xl font-bold tracking-tight">NEON EML Data Browser</h1>
                    <p class="mt-2 text-lg md:text-xl text-slate-200">Explore Ecological Markup Language datasets with
                        ease.</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="glass-card p-6 rounded-2xl shadow-md mb-8">
                <div class="space-y-4">
                    <div>
                        <label for="urlInput" class="block text-lg font-semibold text-slate-700">EML File URL</label>
                        <input type="url" id="urlInput"
                            class="w-full px-4 py-3 bg-white/80 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all"
                            placeholder="Enter EML XML URL..."
                            value="https://gist.githubusercontent.com/samapriya/c0b6605d278796a3746834bd88c03ce9/raw/87777ad25ed28f246389f9468060668edcf334dd/NEON_D02_BLAN_DP1_10041_001_EML_20220906-20220907_20250129T000730Z.xml">
                    </div>
                    <button
                        class="w-full sm:w-auto px-6 py-3 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-transform hover:scale-105"
                        onclick="loadFromUrl()">Load from URL</button>

                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-slate-300"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <span
                                class="bg-slate-100/50 px-2 text-sm text-slate-500 backdrop-blur-sm rounded-full">OR</span>
                        </div>
                    </div>

                    <div>
                        <label for="fileInput" class="block text-lg font-semibold text-slate-700">Upload Local
                            File</label>
                        <input type="file" id="fileInput" onchange="handleFileUpload(event)" accept=".xml,.eml"
                            class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 cursor-pointer">
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Sidebar -->
                <div class="lg:col-span-1 glass-card p-6 rounded-2xl shadow-md h-fit lg:sticky top-8">
                    <h3 class="text-xl font-bold mb-4">Dataset Explorer</h3>
                    <div id="datasetTree" class="space-y-1"></div>
                </div>

                <!-- Content Area -->
                <div id="contentDisplay" class="lg:col-span-2 glass-card p-6 rounded-2xl shadow-md min-h-[600px]">
                    <div class="flex items-center justify-center h-full">
                        <p class="text-slate-500 text-lg">ðŸ‘† Load an EML file to start exploring.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // --- ICONS ---
        const ICONS = {
            dashboard: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>`,
            database: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>`,
            ruler: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L3 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0L15.3 9l.4.4"></path><path d="m18 2-2 2"></path><path d="m15 5-2 2"></path><path d="m12 8-2 2"></path><path d="m9 11-2 2"></path><path d="m6 14-2 2"></path><path d="m3 17-2 2"></path></svg>`,
            flask: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 2v10.3a2 2 0 0 0 .5.5l4.5 3.5a2 2 0 0 1 1 1.7V20a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1.5a2 2 0 0 1 1-1.7l4.5-3.5a2 2 0 0 0 .5-.5V2h4"></path></svg>`,
            code: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>`,
            chevron: `<svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`,
            dollar: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`
        };

        // --- SI UNIT CONVERSION ---
        const SI_UNITS = {
            length: { name: 'meter', symbol: 'm' },
            mass: { name: 'kilogram', symbol: 'kg' },
            time: { name: 'second', symbol: 's' },
            current: { name: 'ampere', symbol: 'A' },
            temperature: { name: 'kelvin', symbol: 'K' },
            amount: { name: 'mole', symbol: 'mol' },
            luminosity: { name: 'candela', symbol: 'cd' },
            angle: { name: 'radian', symbol: 'rad' },
            dimensionless: { name: 'dimensionless', symbol: '' }
        };

        function convertDimensionsToSI(dimensions) {
            const superMap = { '0': 'â°', '1': 'Â¹', '2': 'Â²', '3': 'Â³', '4': 'â´', '5': 'âµ', '6': 'â¶', '7': 'â·', '8': 'â¸', '9': 'â¹', '-': 'â»' };
            const toSuper = (str) => str.split('').map(char => superMap[char] || char).join('');

            const positiveDims = dimensions.filter(d => parseInt(d.power) > 0);
            const negativeDims = dimensions.filter(d => parseInt(d.power) < 0);

            let name = positiveDims.map(d => (d.power !== '1' ? `square ${SI_UNITS[d.name]?.name}` : SI_UNITS[d.name]?.name)).join(' ');
            if (negativeDims.length > 0) {
                name += ' per ' + negativeDims.map(d => (d.power !== '-1' ? `square ${SI_UNITS[d.name]?.name}` : SI_UNITS[d.name]?.name)).join(' ');
            }

            const symbolWithNegExp = dimensions
                .map(d => (SI_UNITS[d.name]?.symbol || d.name) + (d.power !== '1' ? toSuper(d.power) : ''))
                .join('Â·');

            const numerator = positiveDims.map(d => (SI_UNITS[d.name]?.symbol || d.name) + (d.power !== '1' ? toSuper(d.power) : '')).join('Â·');
            const denominator = negativeDims.map(d => (SI_UNITS[d.name]?.symbol || d.name) + (d.power !== '-1' ? toSuper(String(Math.abs(parseInt(d.power)))) : '')).join('Â·');
            let symbolWithDiv = numerator || '';
            if (denominator) {
                if (!numerator && negativeDims.length === 1) {
                    symbolWithDiv = `1/${denominator}`;
                } else if (!numerator && negativeDims.length > 1) {
                    symbolWithDiv = `1/(${denominator})`;
                } else if (negativeDims.length > 1) {
                    symbolWithDiv = `${numerator}/(${denominator})`;
                } else {
                    symbolWithDiv = `${numerator}/${denominator}`;
                }
            }

            if (dimensions.length === 1 && dimensions[0].name === 'dimensionless') {
                return { name: 'dimensionless', symbol: 'dimensionless', symbolWithNegExp: 'dimensionless' };
            }

            return { name: name.trim().replace(/\s+/g, ' '), symbol: symbolWithDiv, symbolWithNegExp };
        }

        // --- PARSING FUNCTIONS ---
        function emlToStac(xmlDoc) {
            const dataset = xmlDoc.querySelector('dataset');
            if (!dataset) throw new Error('No <dataset> element found in the EML file.');

            return {
                type: "Feature",
                stac_version: "1.0.0",
                id: dataset.getAttribute('id') || 'unknown-id',
                properties: {
                    title: getTextContent(dataset, 'title'),
                    description: getTextContent(dataset, 'shortName'),
                    datetime: extractTemporalCoverage(dataset),
                    platform: "NEON",
                },
                geometry: extractGeometry(dataset),
                bbox: extractBbox(dataset),
                assets: {},
                links: Array.from(dataset.querySelectorAll('distribution online url')).map(url => ({
                    href: url.textContent.trim(),
                    rel: url.getAttribute('function') || 'related',
                    type: 'text/html'
                })),
                collection: extractCollectionInfo(dataset),
                neon_metadata: {
                    site_info: extractSiteInfo(dataset),
                    data_tables: extractDataTables(dataset),
                    project_info: extractProjectInfo(dataset),
                    quality_info: extractQualityInfo(dataset),
                    units: extractUnits(xmlDoc)
                }
            };
        }

        function getTextContent(parent, selector) {
            const element = parent.querySelector(selector);
            return element ? element.textContent.trim() : null;
        }

        function extractUnits(xmlDoc) {
            const unitList = xmlDoc.querySelector('unitList');
            if (!unitList) return { units: {}, unitTypes: {} };
            const units = {};
            unitList.querySelectorAll('unit').forEach(u => {
                units[u.getAttribute('id')] = {
                    id: u.getAttribute('id'), name: u.getAttribute('name'), abbreviation: u.getAttribute('abbreviation'),
                    unitType: u.getAttribute('unitType'), parentSI: u.getAttribute('parentSI'), multiplierToSI: u.getAttribute('multiplierToSI')
                };
            });
            const unitTypes = {};
            unitList.querySelectorAll('unitType').forEach(ut => {
                const dimensions = Array.from(ut.querySelectorAll('dimension')).map(d => ({ name: d.getAttribute('name'), power: d.getAttribute('power') || '1' }));
                unitTypes[ut.getAttribute('id')] = {
                    id: ut.getAttribute('id'),
                    name: ut.getAttribute('name'),
                    dimensions: dimensions,
                    si: convertDimensionsToSI(dimensions)
                };
            });
            return { units, unitTypes };
        }

        function extractTemporalCoverage(dataset) {
            const beginDate = getTextContent(dataset, 'beginDate calendarDate');
            const endDate = getTextContent(dataset, 'endDate calendarDate');
            if (!beginDate || !endDate) return null;
            return { start: `${beginDate}T00:00:00Z`, end: `${endDate}T23:59:59Z` };
        }

        function extractGeometry(dataset) {
            const coords = ['westBoundingCoordinate', 'eastBoundingCoordinate', 'northBoundingCoordinate', 'southBoundingCoordinate'].map(c => parseFloat(getTextContent(dataset, c)));
            if (coords.some(isNaN)) return null;
            return { type: "Point", coordinates: [(coords[0] + coords[1]) / 2, (coords[2] + coords[3]) / 2] };
        }

        function extractBbox(dataset) {
            const coords = ['westBoundingCoordinate', 'southBoundingCoordinate', 'eastBoundingCoordinate', 'northBoundingCoordinate'].map(c => parseFloat(getTextContent(dataset, c)));
            return coords.some(isNaN) ? null : coords;
        }

        function extractCollectionInfo(dataset) {
            const id = dataset.getAttribute('id');
            const domainId = id ? id.split('.')[1] : 'unknown';
            const siteId = id ? id.split('.')[2] : 'unknown';
            return {
                id: `neon-${domainId}-${siteId}`, title: `NEON ${domainId} ${siteId} Collection`,
                description: getTextContent(dataset, 'purpose') || 'NEON ecological data collection',
            };
        }

        function extractSiteInfo(dataset) {
            const id = dataset.getAttribute('id');
            return {
                geographic_description: getTextContent(dataset, 'geographicDescription'),
                altitude: { min: parseFloat(getTextContent(dataset, 'altitudeMinimum')), max: parseFloat(getTextContent(dataset, 'altitudeMaximum')), units: getTextContent(dataset, 'altitudeUnits') },
                domain: id ? id.split('.')[1] : null, site: id ? id.split('.')[2] : null
            };
        }

        function extractDataTables(dataset) {
            return Array.from(dataset.querySelectorAll('dataTable')).map(table => ({
                entity_name: getTextContent(table, 'entityName'),
                record_count: parseInt(getTextContent(table, 'numberOfRecords'), 10),
                attributes: Array.from(table.querySelectorAll('attribute')).map(attr => ({
                    name: getTextContent(attr, 'attributeName'), definition: getTextContent(attr, 'attributeDefinition'),
                    measurement_scale: extractMeasurementScale(attr)
                }))
            }));
        }

        function extractMeasurementScale(attr) {
            const scaleEl = attr.querySelector('measurementScale');
            if (!scaleEl) return null;
            const scaleType = scaleEl.children[0]?.tagName.toLowerCase();
            const result = { type: scaleType };
            if (scaleType === 'ratio' || scaleType === 'interval') {
                result.unit = getTextContent(scaleEl, 'unit customUnit') || getTextContent(scaleEl, 'unit standardUnit');
                result.precision = getTextContent(scaleEl, 'precision');
                result.number_type = getTextContent(scaleEl, 'numberType');
            } else if (scaleType === 'dateTime') {
                result.format = getTextContent(scaleEl, 'formatString');
            }
            return result;
        }

        function extractProjectInfo(dataset) {
            const project = dataset.querySelector('project');
            if (!project) return null;
            return {
                title: getTextContent(project, 'title'),
                abstract: getTextContent(project, 'abstract para'),
                funding: getTextContent(project, 'funding para'),
                awards: Array.from(project.querySelectorAll('award')).map(award => ({
                    funder: getTextContent(award, 'funderName'), number: getTextContent(award, 'awardNumber'),
                    title: getTextContent(award, 'title'), url: getTextContent(award, 'awardUrl')
                }))
            };
        }

        function extractQualityInfo(dataset) {
            return {
                maintenance_frequency: getTextContent(dataset, 'maintenance maintenanceUpdateFrequency'),
                rights: getTextContent(dataset, 'intellectualRights para'),
                publication_date: getTextContent(dataset, 'pubDate')
            };
        }

        // --- CORE APP LOGIC ---
        async function loadFromUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                alert('Please enter a valid URL to load.');
                return;
            }
            document.getElementById('fileInput').value = ''; // Clear file input
            const contentDisplay = document.getElementById('contentDisplay');
            contentDisplay.innerHTML = `<div class="text-center p-10 text-slate-500">Loading from URL...</div>`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const xmlText = await response.text();
                processEMLText(xmlText);
            } catch (error) {
                contentDisplay.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong> <span class="block sm:inline">${error.message}</span></div>`;
                console.error('Error loading EML file from URL:', error);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('urlInput').value = ''; // Clear URL input
            const contentDisplay = document.getElementById('contentDisplay');
            contentDisplay.innerHTML = `<div class="text-center p-10 text-slate-500">Reading file...</div>`;

            const reader = new FileReader();
            reader.onload = (e) => processEMLText(e.target.result);
            reader.onerror = (e) => {
                console.error("File could not be read:", e.target.error);
                contentDisplay.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong> <span class="block sm:inline">Could not read the selected file.</span></div>`;
            };
            reader.readAsText(file);
        }

        function processEMLText(xmlText) {
            const contentDisplay = document.getElementById('contentDisplay');
            contentDisplay.innerHTML = `<div class="text-center p-10 text-slate-500">Processing EML data...</div>`;

            setTimeout(() => {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    const parseError = xmlDoc.querySelector("parsererror");
                    if (parseError) {
                        console.error("XML Parsing Error:", parseError.textContent);
                        throw new Error("XML parsing error. Please check if the file is a valid XML/EML document.");
                    }

                    currentData = emlToStac(xmlDoc);
                    buildNavigationTree();
                    showOverview();
                } catch (error) {
                    contentDisplay.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">Error:</strong> <span class="block sm:inline">${error.message}</span></div>`;
                    console.error('Error processing EML text:', error);
                }
            }, 10);
        }


        // --- UI & NAVIGATION ---
        function buildNavigationTree() {
            const tree = document.getElementById('datasetTree');
            tree.innerHTML = '';

            const createNode = (icon, title, children) => {
                const isParent = children && children.length > 0;
                return `
                    <div class="py-1">
                        <div class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-sky-100 transition-colors ${isParent ? 'font-semibold' : ''}"
                             onclick="${isParent ? 'toggleNode(this)' : children[0].onclick}">
                            <div class="flex items-center">${icon}<span>${title}</span></div>
                            ${isParent ? ICONS.chevron : ''}
                        </div>
                        ${isParent ? `<div class="pl-6 mt-1 space-y-1 hidden">${children.map(c => c.html).join('')}</div>` : ''}
                    </div>`;
            };

            const createChild = (title, onClick) => ({
                html: `<div class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-slate-200" onclick="${onClick}">${title}</div>`,
                onclick
            });

            tree.innerHTML = [
                createNode(ICONS.dashboard, 'Dataset Overview', [createChild('Summary', 'showOverview()')]),
                createNode(ICONS.database, 'Data Tables', currentData.neon_metadata.data_tables.map((table, i) => createChild(table.entity_name.split('.').pop(), `showDataTable(${i})`))),
                createNode(ICONS.ruler, 'Unit Definitions', [createChild('View Units', 'showUnits()')]),
                createNode(ICONS.flask, 'Project Info', [createChild('Details', 'showProject()'), createChild('Funding & Awards', 'showFunding()')]),
                createNode(ICONS.code, 'STAC JSON', [createChild('View Full JSON', 'showSTACView()')])
            ].join('');
        }

        function toggleNode(element) {
            const childrenContainer = element.nextElementSibling;
            const icon = element.querySelector('svg:last-child');
            childrenContainer.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // --- CONTENT RENDERERS ---
        function renderCard(title, content) {
            document.getElementById('contentDisplay').innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm animate-fade-in">
                    <h2 class="text-2xl font-bold text-sky-800 mb-6 flex items-center">${title}</h2>
                    ${content}
                </div>
                <style> @keyframes fade-in { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-out; } </style>
                `;
        }

        function showOverview() {
            const { properties, id, neon_metadata } = currentData;
            const content = `<div class="space-y-4">
                    <p class="text-lg">${properties.description || 'No description available.'}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">ID:</strong> ${id}</div>
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">Platform:</strong> ${properties.platform}</div>
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">Domain:</strong> ${neon_metadata.site_info.domain || 'N/A'}</div>
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">Site:</strong> ${neon_metadata.site_info.site || 'N/A'}</div>
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">Data Tables:</strong> ${neon_metadata.data_tables.length}</div>
                        <div class="bg-slate-50 p-4 rounded-lg"><strong class="text-slate-600">Total Records:</strong> ${neon_metadata.data_tables.reduce((s, t) => s + (t.record_count || 0), 0)}</div>
                    </div></div>`;
            renderCard(`${ICONS.dashboard} ${properties.title}`, content);
        }

        function showDataTable(index) {
            const table = currentData.neon_metadata.data_tables[index];
            const content = `<div class="mb-6 space-y-2">
                    <p><strong class="text-slate-600">Entity Name:</strong> ${table.entity_name}</p>
                    <p><strong class="text-slate-600">Record Count:</strong> ${table.record_count || 'Unknown'}</p>
                </div>
                <h3 class="text-xl font-bold text-sky-700 mb-4">Attributes</h3>
                <div class="space-y-4">${table.attributes.map(attr => `
                    <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <p class="font-semibold text-slate-800">${attr.name}</p>
                        <p class="text-slate-600 mt-1">${attr.definition || 'No definition.'}</p>
                        ${attr.measurement_scale ? `<div class="mt-2 text-sm space-x-4">
                                <span class="inline-block bg-sky-100 text-sky-800 px-2 py-1 rounded">Type: ${attr.measurement_scale.type}</span>
                                ${attr.measurement_scale.unit ? `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded">Unit: ${attr.measurement_scale.unit}</span>` : ''}
                            </div>` : ''}
                    </div>`).join('')}</div>`;
            renderCard(`${ICONS.database} ${table.entity_name.split('.').pop()}`, content);
        }

        function showUnits() {
            const { units, unitTypes } = currentData.neon_metadata.units;
            const unitsContent = Object.values(units).map(u => `<div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                    <p class="font-semibold text-slate-800">${u.name} (${u.abbreviation || u.id})</p>
                    <div class="mt-2 text-sm space-x-4">
                        <span class="inline-block bg-sky-100 text-sky-800 px-2 py-1 rounded">Type: ${u.unitType}</span>
                        ${u.parentSI ? `<span class="inline-block bg-slate-200 px-2 py-1 rounded">Parent SI: ${u.parentSI}</span>` : ''}
                        ${u.multiplierToSI ? `<span class="inline-block bg-slate-200 px-2 py-1 rounded">Multiplier: ${u.multiplierToSI}</span>` : ''}
                    </div></div>`).join('');
            const unitTypesContent = Object.values(unitTypes).map(ut => `<div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                    <p class="font-semibold text-slate-800">${ut.name} (<code>${ut.id}</code>)</p>
                    <p class="mt-1 text-slate-600">Dimensions: ${ut.dimensions.map(d => `${d.name}<sup>${d.power}</sup>`).join(' &middot; ')}</p>
                    <div class="mt-2 p-3 bg-sky-50 rounded-md">
                        <p><strong class="text-sky-800">SI Unit:</strong> ${ut.si.name}</p>
                        <p><strong class="text-sky-800">SI Symbol:</strong> <code>${ut.si.symbol}</code> or <code>${ut.si.symbolWithNegExp}</code></p>
                    </div>
                </div>`).join('');
            const content = `<h3 class="text-xl font-bold text-sky-700 mb-4">Units</h3><div class="space-y-4 mb-8">${unitsContent}</div>
                <h3 class="text-xl font-bold text-sky-700 mb-4">Unit Types</h3><div class="space-y-4">${unitTypesContent}</div>`;
            renderCard(`${ICONS.ruler} Unit Definitions`, content);
        }

        function showProject() {
            const { project_info } = currentData.neon_metadata;
            const content = `<div class="space-y-4">
                    <div><h4 class="font-semibold text-slate-700">Abstract</h4><p class="text-slate-600">${project_info.abstract || 'N/A'}</p></div>
                    <div><h4 class="font-semibold text-slate-700">Funding</h4><p class="text-slate-600">${project_info.funding || 'N/A'}</p></div>
                </div>`;
            renderCard(`${ICONS.flask} ${project_info.title}`, content);
        }

        function showFunding() {
            const { awards } = currentData.neon_metadata.project_info;
            if (!awards || awards.length === 0) {
                renderCard(`${ICONS.dollar} Funding & Awards`, '<p>No detailed award information available.</p>');
                return;
            }
            const content = `<div class="space-y-4">${awards.map(award => `
                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                    <p class="font-semibold text-slate-800">${award.title}</p>
                    <p class="text-slate-600 mt-1">Award #${award.number}</p>
                    <div class="mt-2 text-sm space-y-1">
                        <p><strong class="text-slate-600">Funder:</strong> ${award.funder}</p>
                        ${award.url ? `<p><strong class="text-slate-600">Link:</strong> <a href="${award.url}" target="_blank" class="text-sky-600 hover:underline">View Award Details</a></p>` : ''}
                    </div></div>`).join('')}</div>`;
            renderCard(`${ICONS.dollar} Funding & Awards`, content);
        }

        function showSTACView() {
            const content = `<p class="mb-4 text-slate-600">This is the EML data converted to a STAC-like JSON structure.</p>
                <pre class="bg-slate-800 text-slate-200 p-4 rounded-lg text-sm overflow-auto max-h-[500px]"><code>${JSON.stringify(currentData, null, 2)}</code></pre>
                <div class="mt-4 flex items-center space-x-4">
                    <button class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700" onclick="copyToClipboard()">Copy JSON</button>
                    <button class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700" onclick="downloadJSON()">Download JSON</button>
                </div>`;
            renderCard(`${ICONS.code} STAC JSON Representation`, content);
        }

        // --- UTILITY FUNCTIONS ---
        function copyToClipboard() {
            navigator.clipboard.writeText(JSON.stringify(currentData, null, 2)).then(() => {
                alert('STAC JSON copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy JSON:', err);
                alert('Failed to copy JSON. See console for details.');
            });
        }

        function downloadJSON() {
            const jsonString = JSON.stringify(currentData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentData.id || 'eml-data'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Auto-load the sample URL on page load
        window.addEventListener('load', loadFromUrl);
    </script>
</body>

</html>
