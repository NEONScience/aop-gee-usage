name: catalog_stats_complete
on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"  # Run daily at 22:00 UTC (5:00 PM CDT)

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow the action to commit and push changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}'
          
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Generate Earth Engine Stats JSON
        run: python generate_earth_engine_stats.py
            
      - name: Verify JSON output
        run: |
          if [ -f "catalog_stats.json" ]; then
            echo "JSON file generated successfully"
            echo "File size: $(stat -c%s catalog_stats.json) bytes"
            echo "First few lines:"
            head -10 catalog_stats.json
            echo "Checking for STAC catalog information..."
            if grep -q "stac_catalog_info" catalog_stats.json; then
              echo "STAC catalog statistics found in output"
            else
              echo "WARNING: STAC catalog statistics not found in output"
            fi
          else
            echo "ERROR: JSON file was not generated"
            exit 1
          fi
          
      - name: Commit and push changes
        run: |
          export TZ="America/Denver"
          today=$(date +"%Y-%m-%d %H:%M MDT")
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add catalog_stats.json
          git commit -m "Updated Earth Engine moving window stats with STAC catalog integration ${today}" -a
          git push
